<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Managing large SpaDES projects • SpaDES.project</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Managing large SpaDES projects">
<meta property="og:description" content="SpaDES.project">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-58633549-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-58633549-3');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpaDES.project</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/i-getting-started.html">Installing SpaDES</a>
    </li>
    <li>
      <a href="../articles/ii-managing-large-SpaDES-projects.html">Managing large SpaDES projects</a>
    </li>
    <li>
      <a href="../articles/iii-using-git-github.html">Using git for project development</a>
    </li>
    <li>
      <a href="../articles/iv-LandR-fireSense.html">Working with LandR-fireSense</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/PredictiveEcology/SpaDES.project/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Managing large SpaDES projects</h1>
                        <h4 data-toc-skip class="author">Alex M. Chubaty</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/PredictiveEcology/SpaDES.project/blob/HEAD/vignettes/ii-managing-large-SpaDES-projects.Rmd" class="external-link"><code>vignettes/ii-managing-large-SpaDES-projects.Rmd</code></a></small>
      <div class="hidden name"><code>ii-managing-large-SpaDES-projects.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#library("SpaDES.project")</span></code></pre></div>
<p><em>This vignette expands upon blog posts originally posted on the Predictive Ecology website<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> <a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</em></p>
<div class="section level2">
<h2 id="project-directory-structure">Project directory structure<a class="anchor" aria-label="anchor" href="#project-directory-structure"></a>
</h2>
<p>The simplest structure is to use a single directory for all project-related components:</p>
<pre><code>myProject/
|_  cache/            # use this for your simulation cachePath
|_  inputs/           # use this for your simulation inputPath
|_  manuscripts/
|_  modules/          # use this for your simulation modulePath
    |_  module1/
    |_  module2/
    |_  module3/
    |_  module4/
    |_  module5/
|_  outputs/          # use this for your simulation outputPath
|_  packages/         # project-specific package library
...</code></pre>
<p>Most SpaDES users will get modules via <code>downloadModule()</code>, and should save these modules in the project’s <code>modules/</code> sub-directory. New modules should also be created in this directory. Remember that each module should be self-contained, and that data are typically stored in the module’s <code>data/</code> sub-directory (though, see below re: <code>inputs/</code>).</p>
<div class="section level3">
<h3 id="filepaths">Filepaths<a class="anchor" aria-label="anchor" href="#filepaths"></a>
</h3>
<ul>
<li><p>use relative file paths <em>within</em> the main project directory</p></li>
<li>
<p>paths external to the project, such as <code>/tmp</code> and <code>/scratch</code>, may not be globally available, so avoid hardcoding these:</p>
<ul>
<li>use per-user and per-machine configurations, or setup symlinks to these location that point to their system-specific locations</li>
<li>e.g., <code>myProject/scratch --&gt; /scratch/myUser/myProject/</code>
</li>
<li>e.g., use <code>file.path(tempdir(), "myProject")</code> instead of <code>/tmp/myProject</code> to ensure cross-platform availability e.g., on Windows</li>
</ul>
</li>
<li><p>do <em>not</em> use <code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd()</a></code> nor <code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd()</a></code> within scripts, modules, etc.</p></li>
</ul>
<p>It’s useful to define all your projects paths in a single location (i.e., <code>03-paths.R</code>). Paths can be defined for e.g., data preparation steps, simulation runs, and post-processing stages:</p>
<ol style="list-style-type: decimal">
<li>
<p>Use named lists:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scratchDir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Require.predictiveecology.org/reference/checkPath.html" class="external-link">checkPath</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">scratchDir</span>, <span class="va">studyAreaName</span><span class="op">)</span>, create <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">## basedir set in config</span>

<span class="va">defaultPaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  cachePath <span class="op">=</span> <span class="va">cacheDir</span>,
  modulePath <span class="op">=</span> <span class="st">"modules"</span>,
  inputPath <span class="op">=</span> <span class="st">"inputs"</span>,
  outputPath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"outputs"</span>, <span class="va">studyAreaName</span><span class="op">)</span>,
  scratchPath <span class="op">=</span> <span class="va">scratchDir</span>
<span class="op">)</span>

<span class="va">dataPrepPaths</span> <span class="op">&lt;-</span> <span class="va">defaultPaths</span>
<span class="va">dataPrepPaths</span><span class="op">[[</span><span class="st">"cachePath"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cacheDir</span>, <span class="st">"cache_dataPrep"</span><span class="op">)</span>

<span class="co">## main (dynamic) simulation</span>
<span class="va">dynamicPaths</span> <span class="op">&lt;-</span> <span class="va">defaultPaths</span>
<span class="va">dynamicPaths</span><span class="op">[[</span><span class="st">"cachePath"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cacheDir</span>, <span class="st">"cache_sim"</span><span class="op">)</span>
<span class="va">dynamicPaths</span><span class="op">[[</span><span class="st">"outputPath"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"outputs"</span>, <span class="va">runName</span><span class="op">)</span>

<span class="co">## postprocessing paths</span>
<span class="va">posthocPaths</span> <span class="op">&lt;-</span> <span class="va">defaultPaths</span>
<span class="va">posthocPaths</span><span class="op">[[</span><span class="st">"cachePath"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">cacheDir</span>, <span class="st">"cache_posthoc"</span>, <span class="va">studyAreaName</span><span class="op">)</span>
<span class="va">posthocPaths</span><span class="op">[[</span><span class="st">"outputPath"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="va">defaultPaths</span><span class="op">[[</span><span class="st">"outputPath"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</li>
<li>
<p>Use <code><a href="https://spades-core.predictiveecology.org/reference/setPaths.html" class="external-link">SpaDES.core::setPaths()</a></code> at the top of each script for each stage, to ensure those paths are used:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">setPaths</span>, <span class="va">dataPrepPaths</span><span class="op">)</span></code></pre></div>
</li>
<li><p>Even when using <code>setPaths()</code>, you should still pass the named path lists to <code>simInit()</code> and <code>spades()</code> calls. Likewise, pass e.g., <code>dataPrepPaths[["cachePath"]]</code> directly to <code>Cache()</code> calls. (See below for parallel-safe best practices.)</p></li>
<li><p>Be careful switching paths partway through a script!</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="project-caches-cache">Project caches (<code>cache/</code>)<a class="anchor" aria-label="anchor" href="#project-caches-cache"></a>
</h3>
<ul>
<li>Caching reduces computation time for long or computationally intensive steps.</li>
<li>Using separate cache directories for each stage in the workflow can be helpful, especially during development, where you may need to clear caches frequently during testing.</li>
<li>By default, <code>Cache()</code> uses an sqlite database as the backend, and stores objects as <code>qs</code> files.</li>
<li>Other database backends are possible: PostgreSQL is the most well-tested of these (see <a href="https://reproducible.predictiveecology.org/articles/Cache-using-postgresql.html" class="external-link uri">https://reproducible.predictiveecology.org/articles/Cache-using-postgresql.html</a>).</li>
<li>if using <code>git</code>, make sure this directory is listed in <code>.gitignore</code>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="simulation-inputs-inputs">Simulation inputs (<code>inputs/</code>)<a class="anchor" aria-label="anchor" href="#simulation-inputs-inputs"></a>
</h3>
<ul>
<li>Using a single location for all project data is often preferred over the default behaviour of storing module data in each module’s <code>data/</code> directories because it reduces duplication of common data objects.</li>
<li>if using <code>git</code>, make sure this directory is listed in <code>.gitignore</code>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="simulation-outputs-outputs">Simulation outputs (<code>outputs/</code>)<a class="anchor" aria-label="anchor" href="#simulation-outputs-outputs"></a>
</h3>
<ul>
<li>Specify unique output subdirectories for each run/rep (these are typically scenario-specific).</li>
<li>If using <code>git</code>, make sure this directory is listed in <code>.gitignore</code>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="standalone-package-library-packages">Standalone package library (<code>packages/</code>)<a class="anchor" aria-label="anchor" href="#standalone-package-library-packages"></a>
</h3>
<p>We don’t want project libraries interfering with other projects, or our user’s default package library, so it’s best to use a standalone package library. This is easily setup using the <code>Require</code> package, and optionally, using an environment variable (<code>PRJ_PKG_DIR</code>) to set the relative package library path for the project. Setting this by default in <code>.Rprofile</code> is useful, but note that <code>.Rprofile</code> won’t always be read when sourcing your global control script, or e.g. from <code>Rscript</code> calls from the terminal.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="st">".Renviron"</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/readRenviron.html" class="external-link">readRenviron</a></span><span class="op">(</span><span class="st">".Renviron"</span><span class="op">)</span>

<span class="va">pkgDir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"PRJ_PKG_DIR"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">pkgDir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">pkgDir</span> <span class="op">&lt;-</span> <span class="st">"packages"</span> <span class="co">## default: use subdir within project directory</span>
<span class="op">}</span>
<span class="va">pkgDir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/normalizePath.html" class="external-link">normalizePath</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pkgDir</span>, <span class="va">version</span><span class="op">$</span><span class="va">platform</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">version</span><span class="op">$</span><span class="va">major</span>, <span class="st">"."</span>, <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">version</span><span class="op">$</span><span class="va">minor</span>, <span class="st">"[.]"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,
  winslash <span class="op">=</span> <span class="st">"/"</span>,
  mustWork <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">pkgDir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">pkgDir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/libPaths.html" class="external-link">.libPaths</a></span><span class="op">(</span><span class="va">pkgDir</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Using libPaths:\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/libPaths.html" class="external-link">.libPaths</a></span><span class="op">(</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="control-scripts">Control scripts<a class="anchor" aria-label="anchor" href="#control-scripts"></a>
</h2>
<p>Although individual modules will be doing most of the heavy lifting during simulations, these modules still need to be initialized and parameterized correctly. Smaller projects may simply rely on a single ‘global’ control script (e.g., <code>global.R</code>) to run the simulations. However, larger, more complex, projects benefit from splitting up the workflow across a series of control scripts, which should be sequenced and grouped based on their function. This allows each ‘stage’ of the workflow to e.g., be cached or independently executed. For example, a project directory may contain the following control scripts:</p>
<pre><code>|_ 00-global.R       # the main control script; source()'s the others
|_ 01-packages.R     # install/load all packages used
|_ 02-init.R         # parameter initialization
|_ 03-paths.R        # define and create paths
|_ 04-options.R      # set R and package options
|_ 05-runSim.R       # initialize and run the simulation
|_ 06-postprocessing.R # post-simulation analyses/results summaries
...                    # other scripts</code></pre>
<p>In addition to these R scripts, other scripts (e.g., <code>bash</code>, <code>slurm</code>) may be used to setup batch runs and/or run simulations on HPC clusters.</p>
<div class="section level3">
<h3 id="main-script">Main script<a class="anchor" aria-label="anchor" href="#main-script"></a>
</h3>
<p>The primary (global, a.k.a. main) script defines the (usually linear) flow of the other scripts and should be kept as clutter-free as possible. The simplest approach to structuring your workflow is to assume the user will run the main script interactively (e.g., line-by-line) or from the command line (e.g., <code>Rscript 00-global.R</code>). In order to facilitate running this global script for use with different simulation scenarios, on different machines, by different users, as well as being able to easily reuse scripts with different, but related projects, it’s important to reduce idiosyncracies in these scripts by putting user-configurable components into separate config or options files. To ensure these can quickly be rerun, it’s critical to stash intermediate results so that long or intensive computations don’t need to be rerun each time.</p>
</div>
<div class="section level3">
<h3 id="package-installation-and-loading">Package installation and loading<a class="anchor" aria-label="anchor" href="#package-installation-and-loading"></a>
</h3>
<p>Check that all necessary packages are declared, and ensure they are installed <em>before</em> loading any of them, or you will encounter problems with namespaces being loaded and being unable to detach packages during installation.</p>
<p>The <code>Require</code> package facilitates this, and checks for modules’ package dependencies:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://Require.predictiveecology.org" class="external-link">"Require"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"Require"</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Require.predictiveecology.org" class="external-link">Require</a></span><span class="op">)</span>
<span class="op">}</span>

<span class="va">.spatialPkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lwgeom"</span>, <span class="st">"rgdal"</span>, <span class="st">"rgeos"</span>, <span class="st">"sf"</span>, <span class="st">"sp"</span>, <span class="st">"stars"</span>, <span class="st">"raster"</span>, <span class="st">"terra"</span><span class="op">)</span>

<span class="fu"><a href="https://Require.predictiveecology.org/reference/Require.html" class="external-link">Require</a></span><span class="op">(</span><span class="st">"PredictiveEcology/SpaDES.install@development"</span><span class="op">)</span>

<span class="fu">installSpaDES</span><span class="op">(</span>dontUpdate <span class="op">=</span> <span class="va">.spatialPkgs</span>, upgrade <span class="op">=</span> <span class="st">"never"</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">installSpatialPackages</span><span class="op">(</span><span class="op">)</span>
  <span class="co">#install.packages(c("raster", "terra"), repos = "https://rspatial.r-universe.dev")</span>
  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf_extSoftVersion.html" class="external-link">sf_extSoftVersion</a></span><span class="op">(</span><span class="op">)</span> <span class="co">## want at least GEOS 3.9.0, GDAL 3.2.1, PROJ 7.2.1</span>
<span class="op">}</span>

<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">makeSureAllPackagesInstalled</span><span class="op">(</span>modulePath <span class="op">=</span> <span class="st">"modules"</span><span class="op">)</span>

<span class="fu"><a href="https://Require.predictiveecology.org/reference/Require.html" class="external-link">Require</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"config"</span>, <span class="st">"RCurl"</span>, <span class="st">"RPostgres"</span>, <span class="st">"tictoc"</span>, <span class="st">"XML"</span><span class="op">)</span>, require <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co">## NOTE: always load packages LAST, after installation above;</span>
<span class="co">##       ensure plyr loaded before dplyr or there will be problems</span>
<span class="fu"><a href="https://Require.predictiveecology.org/reference/Require.html" class="external-link">Require</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data.table"</span>, <span class="st">"plyr"</span>, <span class="st">"pryr"</span>,
          <span class="st">"PredictiveEcology/reproducible@development (&gt;= 1.2.8.9040)"</span>,
          <span class="st">"PredictiveEcology/LandR@development"</span>, <span class="co">## TODO: workaround weird raster/sf method problem</span>
          <span class="st">"PredictiveEcology/SpaDES.core@development (&gt;= 1.0.10.9003)"</span>,
          <span class="st">"archive"</span>, <span class="st">"googledrive"</span>, <span class="st">"httr"</span>, <span class="st">"slackr"</span><span class="op">)</span>, upgrade <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="project-configuration-files">Project configuration files<a class="anchor" aria-label="anchor" href="#project-configuration-files"></a>
</h3>
<p>This workflow recognizes that there are frequently different types of configurable projects parameters. - Some are intended to be set by the user for their machine (e.g., scratch path, or number of CPU threads or amount of RAM to use). - Some are set using different values depending on the desired scenario or replicate being run. These may be passed to individual modules, but controlled at the top level of the simulation control scripts. - Some are package- or module-level options that differ from the defaults, or are explicitly being defined to reduce ambiguity and increase transparency (both of which help reduce coding errors, and speed up debugging).</p>
<p>It is useful to try to group these configurable parameters based on when/how they are used in the simulation, and to keep them organized (e.g., alphabetized) so it’s easy to scan the list of parameters and identify their corresponding values. Thus, there are two (or optionally, three) main places where these values may be set (and thus three places where you should check if you are updating/changing parameters or their values).</p>
<p>The first place is in <code>02-init.R</code> (and optionally, some these values may additionally read in from a config file using e.g., the <code>config</code> package). Parameter values are set here early on and may use those objects later in various places (including e.g., <code>04-options.R</code>).</p>
<p><strong>NB:</strong> When running simulations, it’s typical that a user would be running multiple concurrent simulations and would set a configuration value for the first simulation (A), and want to change the value for the next simulation (B). A problem arises where if the first simulation (A) hasn’t gotten far enough along in the scripts to already have read these values into memory, simulation A could read in the updated value from disk intended for simulation B. Thus, all config values coming from a file (being read from disk) need to be read in as early as possible so if the file changes it won’t interfere with in-progress (or queued future) simulations (i.e., reduce race conditions). <em>Do not reload config or other “controller” values from disk part way through a simulation.</em> This warning also extends to making manual changes in scripts: do not change a value in a script for a subset of runs. It becomes difficult to mentally keep track of these changes when switching between runs, and even if you can keep things straight for your self, your collaborators may mot be so lucky!</p>
<p>To mitigate this, it is useful to encode run information, including key parameter values, in the simulation <code>runName</code>, so that in can be extracted during the simulation. E.g., for <code>runName = "AOU_CCSM4_RCP85_res250_rep01"</code>: - <code>AOU</code> specifies the study area (one of <code>AOU</code> or <code>ROF</code>); - <code>CCSM4_RCP85</code> specifies the climate scenario; - <code>res250</code> is the pixel resolution; and - <code>rep01</code> specifies the replicate/run/realization number. Thus, the construction of the <code>runName</code> can be done by a high-level control script rather than having the user manually edit a configuration file, which is especially useful when doing batch runs.</p>
<p>An alternative approach is to use separate “config” or “param” files for each set of simulations, which for complex projects with multiple defined runs could mean tens or hundreds of nearly identical text files needing to be maintained and updated. Thus, adding a new config option (or removing one) means editing and updating <em>all</em> of those files. Though this approach has other merits, this is a very large drawback.</p>
<p>As alluded to above, another place where configuration parameters are set is in <code>04-options.R</code>. This is a single place where all package-level options are set. They should be listed alphabetically, so that it’s easy for a human to read, find, and modify values. Where these values are not hardcoded to a fixed value (e.g., <code>Ncpus = 8L</code>), they should be set using variables defined in <code>02-init.R</code> (e.g., <code>Ncpus = ncores</code>, where <code>ncores</code> was previously defined as <code>min(parallel::detectCores() / 2, 120)</code>)</p>
<p>The goal is to be able to use a single script for all your simulations. Run names, study areas, etc. should be controlled externally to this (i.e., don’t hardcode runNames unless the control script iterates through a loop of all your study areas.) If using a loop to iterate through e.g., study areas, it’s useful to use lock files (see below) to prevent simultaneous runs from interfering with one another.</p>
<div class="section level4">
<h4 id="replication-and-scenarios">Replication and scenarios<a class="anchor" aria-label="anchor" href="#replication-and-scenarios"></a>
</h4>
<p>The simplest way to provide information about replicate or run id, as well as scenarios, is to provide them as part of the simulation run name (as described above).</p>
<p>The run name (and other metadata about the simulation) can also be inserted into the <code>simList</code> as a ‘dot-object’:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">objects4sim</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  <span class="va">...</span>,
  .runName <span class="op">=</span> <span class="va">runName</span> <span class="co">## runName is a character string</span>
<span class="op">)</span>

<span class="va">...</span>

<span class="va">mySim</span> <span class="op">&lt;-</span> <span class="fu">simInit</span><span class="op">(</span><span class="va">...</span>, objects <span class="op">=</span> <span class="va">objects4sim</span><span class="op">)</span></code></pre></div>
<p>Simulation outputs should be saved in run-specific output directories, thus we suggest using <code>runName</code> as part of the simulations’ output path. This also helps the user when browsing the outputs in the filesystem when examining results.</p>
<div class="section level5">
<h5 id="lockfiles">Lockfiles<a class="anchor" aria-label="anchor" href="#lockfiles"></a>
</h5>
<p>Simulation-specific lock files can be used to help prevent simultaneous runs from interfering with one another when a single control script is used to loop through multiple parameter values or scenarios.</p>
<p>A simple example of using lockfiles for each iteration of <code>studyArea</code> is provided below:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">studyAreas</span>, <span class="kw">function</span><span class="op">(</span><span class="va">studyAreaName</span><span class="op">)</span> <span class="op">{</span>
   <span class="va">...</span>

  <span class="va">lockfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outputPath</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"00-LOCK_"</span>, <span class="va">studyAreaName</span><span class="op">)</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">lockfile</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Found lockfile for study area "</span>, <span class="va">studyAreaName</span>, <span class="st">". Skipping."</span><span class="op">)</span>
    <span class="kw">next</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.create</a></span><span class="op">(</span><span class="va">lockfile</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">lockfile</span><span class="op">)</span><span class="op">}</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">...</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level5">
<h5 id="parallel-safe-best-practices">Parallel-safe best practices<a class="anchor" aria-label="anchor" href="#parallel-safe-best-practices"></a>
</h5>
<ol style="list-style-type: decimal">
<li>
<p>Be aware of and avoid race conditions:</p>
<ol style="list-style-type: lower-alpha">
<li>if multiple processes are expected to access the same file at once (e.g., reading an input file at the start of the simulation), add a random delay using <code><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep()</a></code> to stagger reads;</li>
<li>never write to the same file at the same time! use unique paths/filenames;</li>
<li>avoid simultaneous network calls (especially uploads);</li>
<li>use an alternate <code>Cache()</code> database backend that can better-handle many concurrent reads/writes;</li>
</ol>
</li>
<li><p>Use <code><a href="https://reproducible.predictiveecology.org/reference/retry.html" class="external-link">reproducible::retry()</a></code> to re-attempt failed operations, e.g., if timeouts or other ‘random’ errors occur.</p></li>
<li><p>Ensure file permissions are properly set on network drives.</p></li>
<li><p>Don’t use the <code>Paths</code> “shortcut” in control scripts; use the named path list directly.</p></li>
<li><p>Avoid passing large objects or large amounts of data among compute nodes – this adds substantial overhead!</p></li>
<li><p>Care must be taken when serializing certain objects with reference semantics: typically when writing to <code>rds</code>/<code>qs</code> file or when passing data among compute nodes (specifically, <code>terra</code> objects need to be <code>wrap</code>ped and subsequently unwrapped using <code>rast()</code>).</p></li>
</ol>
</div>
</div>
<div class="section level4">
<h4 id="per-user-and-per-machine-config">Per-user and per-machine config<a class="anchor" aria-label="anchor" href="#per-user-and-per-machine-config"></a>
</h4>
<p>I like using <code>config</code> package plus a <code>config.yml</code> file to set user- and machine-specific options (like scratch directory paths, cache settings, etc.). Using <code>config</code> is optional though, as these usr- and machine-specific settings can also be defined in <code>02-init.R</code>. The important thing is to clearly identify which parameters/values are ‘global’ for all simulations, and which are intended to be changed by the user. Note that no parameters that are expected to be changed for the purposes of running different simulation parameters (e.g., study area) should be set here (see above).</p>
</div>
</div>
<div class="section level3">
<h3 id="save-or-cache-intermediate-results">Save or cache intermediate results<a class="anchor" aria-label="anchor" href="#save-or-cache-intermediate-results"></a>
</h3>
<p>For each computational ‘stage’ of a project workflow, try to ensure that (at a minimum) intermediate results are saved to a file locally. This can be done using the <code>Cache()</code> mechanisms build provided the <code>reproducible</code> and <code>SpaDES.core</code> packages, and can also involve additional “manual” saving of objects using <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code> or <code><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qs::qsave()</a></code>. These objects can be scripted to be loaded on subsequent runs.</p>
<p>To quickly get started with the project on a new machine, one can take advantage of cloud storage provided by Google Drive, and upload/download these saved objects using <code><a href="https://googledrive.tidyverse.org/reference/drive_upload.html" class="external-link">googledrive::drive_upload()</a></code> and <code><a href="https://googledrive.tidyverse.org/reference/drive_download.html" class="external-link">googledrive::drive_download</a></code>. Examples of this use are provided in the advanced project template scripts.</p>
</div>
</div>
<div class="section level2">
<h2 id="version-control">Version control<a class="anchor" aria-label="anchor" href="#version-control"></a>
</h2>
<div class="section level3">
<h3 id="simple-module-versioning">Simple module versioning<a class="anchor" aria-label="anchor" href="#simple-module-versioning"></a>
</h3>
<p>Every module has a version number in its metadata. To download a specific version of a module via <code>downloadModule()</code>, specify the <code>version</code> argument. This should be included in your project’s main script / Rmd file. <em>Every project should be explicit about which versions of the modules it is using.</em></p>
</div>
<div class="section level3">
<h3 id="using-git">Using git<a class="anchor" aria-label="anchor" href="#using-git"></a>
</h3>
<p>More advanced users and developers may choose to use more recent or in-development versions of the modules instead of the versions in the <code>SpaDES-modules</code> repository (and accessed via <code>downloadModule()</code>). Many <code>SpaDES</code> module authors/developers use GitHub for version control, so we can get tagged module versions as well as in-development versions of the code. To use version-controlled <code>SpaDES</code> modules in your project, we use <a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules" class="external-link">git submodules</a>.</p>
<p>Here, we assume that you are familiar with git (and GitHub) and are also using it for version control of your own project.</p>
<pre><code>myProject/            # a version controlled git repo
|_  .git/
|_  cache/            # should be .gitignore'd
|_  inputs/           # should be .gitignore'd (selectively)
|_  manuscripts/
|_  modules/
    |_  module1/      # can be a git submodule
    |_  module2/      # can be a git submodule
    |_  module3/      # can be a git submodule
    |_  module4/      # can be a git submodule
    |_  module5/      # can be a git submodule
|_  outputs/          # should be .gitignore'd
...</code></pre>
<p><strong>Remember that large data files should not managed using <code>git</code>.</strong> Each module’s data directory should have it’s own <code>.gitignore</code> file. These data files should be easily retrieved via download or created by the module. <em>This also means you should add <code>inputs/</code>, <code>outputs/</code>, and <code>cache/</code> to your project directory’s <code>.gitignore</code> file!</em></p>
<div class="section level4">
<h4 id="using-git-submodules">Using git submodules<a class="anchor" aria-label="anchor" href="#using-git-submodules"></a>
</h4>
<p>We will add each of the <code>SpaDES</code> modules to our project as git submodules via the command line (but <a href="https://support.gitkraken.com/working-with-repositories/submodules" class="external-link">GitKraken does support git submodules</a>). (You’ll need to delete the <code>moduleN/</code> sub-directories within <code>modules</code>.)</p>
<pre><code>cd ~/Documents/myProject/modules
git submodule add https://github.com/USERNAMEA/module1
git submodule add https://github.com/USERNAMEA/module2
git submodule add https://github.com/USERNAMEB/module3
git submodule add https://github.com/USERNAMEB/module4
git submodule add https://github.com/USERNAMEC/module5
git push origin master</code></pre>
<p>Now our directory structure looks like this:</p>
<pre><code>myProject/            # (https://github.com/MYUSERNAME/myProject)
|_  .git/
|_  cache/            # should be .gitignore'd
|_  inputs/           # should be .gitignore'd (selectively)
|_  manuscripts/
|_  modules/
    |_  module1/      # git submodule (https://github.com/USERNAMEA/module1)
    |_  module2/      # git submodule (https://github.com/USERNAMEA/module2)
    |_  module3/      # git submodule (https://github.com/USERNAMEB/module3)
    |_  module4/      # git submodule (https://github.com/USERNAMEB/module4)
    |_  module5/      # git submodule (https://github.com/USERNAMEC/module5)
|_  outputs/          # should be .gitignore'd
...</code></pre>
<p>In the above example, we are working with 6 different GitHub repositories, one for each <code>SpaDES</code> module plus our <code>myProject</code> repo.</p>
<p>Now, we manage each of the <code>SpaDES</code> modules (git submodules) independently. Because each of these submodules simply link back to another git repository, we can make changes upstream in the corresponding repo. We then need to pull in these upstream changes to specific modules as follows:</p>
<pre><code>cd ~/Documents/myProject/modules
git submodule update --remote module1</code></pre>
<p>If we make changes to modules locally and want to push them to the remote we can do so using:</p>
<pre><code>cd ~/Documents/myProject/modules/module1
git push</code></pre>
<p>This will push only the (committed) changes made to <code>module1</code>.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="parent-and-child-modules">Parent and child modules<a class="anchor" aria-label="anchor" href="#parent-and-child-modules"></a>
</h2>
<p>Another option (as a developer) to make working with multiple <code>SpaDES</code> modules easier, is to create a parent module that specifies a group of modules as its children. In this way, a user only needs to call <code>downloadModule()</code> or <code>simInit()</code> specifying the parent module name.</p>
<p>Even though a parent (and grandparent, etc.) module can be thought hierarchically above child modules, remember that from a directory structure standpoint, all modules (child or parent) are at the same level:</p>
<pre><code>myProject/            # a version controlled git repo
|_  .git/
|_  cache/            # should be .gitignore'd
|_  inputs/           # should be .gitignore'd (selectively)
|_  manuscripts/
|_  modules/
    |_  parent1/      # with children: modules 1-5
    |_  module1/
    |_  module2/
    |_  module3/
    |_  module4/
    |_  module5/
|_  outputs/          # should be .gitignore'd
...</code></pre>
<p>Here, all of these modules (including the parent) can be git modules, and thus managed independently.</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>The take away here is that when it comes to basic project organization, use a single directory for the project, and organize <code>SpaDES</code> modules within a single sub-directory therein. If you’re using <code>git</code> version control (and you really should be using version control!) then <code>git</code> submodules offer an elegant way to manage dependencies.</p>
</div>
<div class="section level2">
<h2 id="other-resources">Other resources<a class="anchor" aria-label="anchor" href="#other-resources"></a>
</h2>
<ul>
<li>Using alternative cache backends [<a href="https://reproducible.predictiveecology.org/articles/Cache-using-postgresql.html" class="external-link">link</a>]</li>
</ul>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>1<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>2<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Alex M Chubaty.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
